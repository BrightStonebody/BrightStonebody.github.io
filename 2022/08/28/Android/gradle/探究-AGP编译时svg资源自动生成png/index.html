<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","width":280,"display":"always","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":20},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":10,"unescape":false,"preload":true},
    path: 'search.xml',
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="背景：当安卓工程的minSdk&amp;lt;24时，项目中的svg资源如果使用到了有兼容问题的属性，同时module的 vectorDrawables.useSupportLibrary 开关为false，会自动在编译打包过程中生成png图片来解决兼容性问题。123456android &amp;#123;    defaultConfig &amp;#123;        vectorDrawables.useSu">
<meta property="og:type" content="article">
<meta property="og:title" content="探究: AGP编译时svg资源自动生成png">
<meta property="og:url" content="http://yoursite.com/2022/08/28/Android/gradle/探究-AGP编译时svg资源自动生成png/index.html">
<meta property="og:site_name" content="BrightStone">
<meta property="og:description" content="背景：当安卓工程的minSdk&amp;lt;24时，项目中的svg资源如果使用到了有兼容问题的属性，同时module的 vectorDrawables.useSupportLibrary 开关为false，会自动在编译打包过程中生成png图片来解决兼容性问题。123456android &amp;#123;    defaultConfig &amp;#123;        vectorDrawables.useSu">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2022-10-16T07:32:07.422Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="探究: AGP编译时svg资源自动生成png">
<meta name="twitter:description" content="背景：当安卓工程的minSdk&amp;lt;24时，项目中的svg资源如果使用到了有兼容问题的属性，同时module的 vectorDrawables.useSupportLibrary 开关为false，会自动在编译打包过程中生成png图片来解决兼容性问题。123456android &amp;#123;    defaultConfig &amp;#123;        vectorDrawables.useSu">

<link rel="canonical" href="http://yoursite.com/2022/08/28/Android/gradle/探究-AGP编译时svg资源自动生成png/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>探究: AGP编译时svg资源自动生成png | BrightStone</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">BrightStone</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/08/28/Android/gradle/探究-AGP编译时svg资源自动生成png/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BrightStone">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BrightStone">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          探究: AGP编译时svg资源自动生成png
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-08-28 14:21:50" itemprop="dateCreated datePublished" datetime="2022-08-28T14:21:50+08:00">2022-08-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-10-16 15:32:07" itemprop="dateModified" datetime="2022-10-16T15:32:07+08:00">2022-10-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="背景："><a href="#背景：" class="headerlink" title="背景："></a>背景：</h2><p>当安卓工程的minSdk&lt;24时，项目中的svg资源如果使用到了有兼容问题的属性，同时module的 vectorDrawables.useSupportLibrary 开关为false，会自动在编译打包过程中生成png图片来解决兼容性问题。<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        vectorDrawables.useSupportLibrary = <span class="keyword">false</span> </span><br><span class="line">        vectorDrawables.generatedDensities = [<span class="string">"xxhdpi"</span>] <span class="comment">// 设置只在drawable-xxhdpi目录下的生成png图片，如果不设置，最终的apk会在每一个drawable目录下有一个png</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><a id="more"></a>
<p>这样兼容性的问题就解决了，但是，生成了很多冗余的png图片。本来我们使用svg就是为了缩小包体积，现在反而包体积增大了。需要去探究一下，冗余的png图片是在哪里生成的，什么情况下额外生成png图片</p>
<h2 id="MergeResources"><a href="#MergeResources" class="headerlink" title="MergeResources"></a>MergeResources</h2><p>基于AGP 4.1.0 版本</p>
<p>通过ide的全局文本查找 useSupportLibrary 出现的地方，可以找到一个明显有嫌疑的类 MergeResources 。<br>这是编译打包过程中的一个task类，需要注意的是，在子module和app，这个task有所不同。它在子module的task-name是packageDebugResource ，在app的task-name是mergeDebugResource。同样，在子module和app，表现也有所不同。</p>
<p>先从doFullTaskAction方法看这个task的主流程：<br>伪代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFullTaskAction</span><span class="params">()</span> <span class="keyword">throws</span> IOException, JAXBException </span>&#123;</span><br><span class="line">    ResourcePreprocessor preprocessor = getPreprocessor(); <span class="comment">// 关键1</span></span><br><span class="line"></span><br><span class="line">    File destinationDir = getOutputDir().get().getAsFile(); </span><br><span class="line">    <span class="comment">// 资源merge的最终目录</span></span><br><span class="line">    <span class="comment">// build/intermediates/package_res</span></span><br><span class="line">    </span><br><span class="line">    ... <span class="comment">//省略</span></span><br><span class="line">    <span class="comment">// 因为是全量，删除destinationDir的所有文件</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取所有资源目录</span></span><br><span class="line">    List&lt;ResourceSet&gt; resourceSets =</span><br><span class="line">            getConfiguredResourceSets(preprocessor, getAaptEnv().getOrNull());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// task 的核心类</span></span><br><span class="line">    ResourceMerger merger = <span class="keyword">new</span> ResourceMerger(getMinSdk().get());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> (</span><br><span class="line">            <span class="comment">// 创建资源编译服务类</span></span><br><span class="line">            ResourceCompilationService resourceCompiler =</span><br><span class="line">                    getResourceProcessor(</span><br><span class="line">                            getProjectName(),</span><br><span class="line">                            getPath(),</span><br><span class="line">                            getAapt2FromMaven(),</span><br><span class="line">                            workerExecutorFacade,</span><br><span class="line">                            errorFormatMode,</span><br><span class="line">                            flags,</span><br><span class="line">                            processResources,</span><br><span class="line">                            useJvmResourceCompiler,</span><br><span class="line">                            getLogger(),</span><br><span class="line">                            getAapt2DaemonBuildService().get())) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ResourceSet resourceSet : resourceSets) &#123;</span><br><span class="line">            resourceSet.loadFromFiles(<span class="keyword">new</span> LoggerWrapper(getLogger())); <span class="comment">// 关键2</span></span><br><span class="line">            merger.addDataSet(resourceSet);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        File publicFile =</span><br><span class="line">                getPublicFile().isPresent() ? getPublicFile().get().getAsFile() : <span class="keyword">null</span>;</span><br><span class="line">        MergedResourceWriter writer =</span><br><span class="line">                <span class="keyword">new</span> MergedResourceWriter(</span><br><span class="line">                        workerExecutorFacade,</span><br><span class="line">                        destinationDir,</span><br><span class="line">                        publicFile,</span><br><span class="line">                        mergingLog,</span><br><span class="line">                        preprocessor,</span><br><span class="line">                        resourceCompiler,</span><br><span class="line">                        getIncrementalFolder(),</span><br><span class="line">                        dataBindingLayoutProcessor,</span><br><span class="line">                        mergedNotCompiledResourcesOutputDirectory,</span><br><span class="line">                        pseudoLocalesEnabled,</span><br><span class="line">                        getCrunchPng());</span><br><span class="line"></span><br><span class="line">        merger.mergeData(writer, <span class="keyword">false</span>) <span class="comment">// 关键3</span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        cleanup();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="关键1-ResourcePreprocessor"><a href="#关键1-ResourcePreprocessor" class="headerlink" title="关键1 ResourcePreprocessor"></a>关键1 ResourcePreprocessor</h3><p>getPreprocessor() 返回的是一个接口<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResourcePreprocessor</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 返回预处理需要生成的file集合</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function">Collection&lt;File&gt; <span class="title">getFilesToBeGenerated</span><span class="params">(@NonNull File original)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成 getFilesToBeGenerated 方法返回的file集合文件</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">generateFile</span><span class="params">(@NonNull File toBeGenerated, @NonNull File original)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>它的实现类是 VectorDrawableRenderer ，看名字可以判定，这就是 svg-&gt;png 的实现类（罪魁祸首）。。。先寻找它被调用的地方。</p>
<h3 id="关键2-ResourceSet-loadFromFiles"><a href="#关键2-ResourceSet-loadFromFiles" class="headerlink" title="关键2 ResourceSet#loadFromFiles"></a>关键2 ResourceSet#loadFromFiles</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (ResourceSet resourceSet : resourceSets) &#123;</span><br><span class="line">    resourceSet.loadFromFiles(<span class="keyword">new</span> LoggerWrapper(getLogger())); <span class="comment">// 关键2</span></span><br><span class="line">    merger.addDataSet(resourceSet);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>resourceSets 是一个res目录的集合。<br>在子module，会包含工程里module的src/main/res目录；（断点看，似乎有用的也就只有这个）<br>在app，会包含 app 的 src/main/res ，所有子module的 build/intermediates/package_res ，以及一些安卓官方库的资源目录<br>从 resourceSet.loadFromFiles 一直追，会到 ResourceSet#getResourceMergerItemsForGeneratedFiles 方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;ResourceMergerItem&gt; <span class="title">getResourceMergerItemsForGeneratedFiles</span><span class="params">(@NonNull File file)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> MergingException </span>&#123;</span><br><span class="line">    Collection&lt;File&gt; filesToBeGenerated;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        filesToBeGenerated = mPreprocessor.getFilesToBeGenerated(file); <span class="comment">// 关键</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MergingException(e);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;ResourceMergerItem&gt; resourceItems = <span class="keyword">new</span> ArrayList&lt;&gt;(filesToBeGenerated.size());</span><br><span class="line">    <span class="keyword">for</span> (File generatedFile : filesToBeGenerated) &#123;</span><br><span class="line">        FolderData generatedFileFolderData =</span><br><span class="line">                getFolderData(generatedFile.getParentFile());</span><br><span class="line">        resourceItems.add(</span><br><span class="line">                <span class="keyword">new</span> GeneratedResourceMergerItem(</span><br><span class="line">                        getNameForFile(generatedFile),</span><br><span class="line">                        mNamespace,</span><br><span class="line">                        generatedFile,</span><br><span class="line">                        generatedFileFolderData.type,</span><br><span class="line">                        generatedFileFolderData.folderConfiguration.getQualifierString(),</span><br><span class="line">                        mLibraryName)</span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resourceItems;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 mPreprocessor 就是 VectorDrawableRenderer ，<code>mPreprocessor.getFilesToBeGenerated(file)</code> 会返回 svg 资源文件和png兼容资源文件的集合。里面不详细看了，主要是根据useSupportLibrary 和generatedDensities 这两个gradle参数生成png文件的绝对路径。<br>这里的png路径是 build/generated/res/pngs/debug 。 这和 MergeResources task 的目标路径并不相同。<br>getResourceMergerItemsForGeneratedFiles 方法最终会将每一个资源文件抽象为ResourceMergerItem ，并返回他们的集合。</p>
<h3 id="关键3-merger-mergeData"><a href="#关键3-merger-mergeData" class="headerlink" title="关键3 merger#mergeData"></a>关键3 merger#mergeData</h3><p>ResourceMerger#mergeData 会调用到父类的 DataMerger#mergeData<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mergeData</span><span class="params">(@NonNull MergeConsumer&lt;I&gt; consumer, <span class="keyword">boolean</span> doCleanUp)</span></span>&#123;</span><br><span class="line">    consumer.start(mFactory);</span><br><span class="line">    <span class="keyword">for</span>(...) &#123;</span><br><span class="line">        ... <span class="comment">// 忽略 merge 的过程</span></span><br><span class="line">        consumer.addItem(toWrite)</span><br><span class="line">    &#125;</span><br><span class="line">    consumer.end();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 consumer 是 MergedResourceWriter 实例。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addItem</span><span class="params">(@NonNull <span class="keyword">final</span> ResourceMergerItem item)</span> <span class="keyword">throws</span> ConsumerException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ResourceFile.FileType type = item.getSourceType();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (type == ResourceFile.FileType.XML_VALUES) &#123;</span><br><span class="line">        mValuesResMap.put(item.getQualifiers(), item);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (item.isTouched()) &#123;</span><br><span class="line">            File file = item.getFile();</span><br><span class="line">            String folderName = getFolderName(item);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (type == DataFile.FileType.GENERATED_FILES) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    FileGenerationParameters workItem =</span><br><span class="line">                            <span class="keyword">new</span> FileGenerationParameters(item, mPreprocessor);</span><br><span class="line">                    <span class="keyword">if</span> (workItem.resourceItem.getSourceFile() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// 这个action是生成png文件的地方</span></span><br><span class="line">                        getExecutor().submit(FileGenerationWorkAction.class, workItem);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ConsumerException(e, item.getSourceFile().getFile());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加资源编译 Request</span></span><br><span class="line">            mCompileResourceRequests.add(</span><br><span class="line">                    <span class="keyword">new</span> CompileResourceRequest(</span><br><span class="line">                            file, getRootFolder(), folderName, item.mIsFromDependency));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有一个 ResourceFile.FileType 枚举值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> FileType &#123;</span><br><span class="line">    SINGLE_FILE,   <span class="comment">// 表示项目中工程目录 src/main/res 原本就有的资源文件</span></span><br><span class="line">    GENERATED_FILES,  <span class="comment">// 需要生成的资源文件，生成的目录在 build/generated/res/pngs/debug </span></span><br><span class="line">    XML_VALUES  <span class="comment">// values文件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果是 GENERATED_FILES 会生成新文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FileGenerationWorkAction</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileGenerationParameters workItem;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FileGenerationWorkAction</span><span class="params">(FileGenerationParameters workItem)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.workItem = workItem;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            workItem.resourcePreprocessor.generateFile(</span><br><span class="line">                    workItem.resourceItem.getFile(),</span><br><span class="line">                    workItem.resourceItem.getSourceFile().getFile());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>workItem.resourcePreprocessor 是 VectorDrawableRenderer 对象，这样生成了png文件的地方也找到了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">generateFile</span><span class="params">(@NonNull File toBeGenerated, @NonNull File original)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Files.createParentDirs(toBeGenerated);</span><br><span class="line">    <span class="keyword">if</span> (isXml(toBeGenerated)) &#123;</span><br><span class="line">        <span class="comment">// 目标文件如果是xml文件，直接拷贝即可</span></span><br><span class="line">        Files.copy(original, toBeGenerated);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 在对应 density 的目录下生成png文件</span></span><br><span class="line">        FolderConfiguration folderConfiguration = getFolderConfiguration(toBeGenerated);</span><br><span class="line">        Density density = folderConfiguration.getDensityQualifier().getValue();</span><br><span class="line">        <span class="keyword">float</span> scaleFactor = density.getDpiValue() / (<span class="keyword">float</span>) Density.MEDIUM.getDpiValue();</span><br><span class="line">        <span class="keyword">if</span> (scaleFactor &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            scaleFactor = <span class="number">1.0f</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        VdPreview.TargetSize imageSize = VdPreview.TargetSize.createFromScale(scaleFactor);</span><br><span class="line">        String xmlContent = Files.asCharSource(original, StandardCharsets.UTF_8).read();</span><br><span class="line">        BufferedImage image = VdPreview.getPreviewFromVectorXml(imageSize, xmlContent, <span class="keyword">null</span>);</span><br><span class="line">        ImageIO.write(image, <span class="string">"png"</span>, toBeGenerated);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>生成png文件的效果<br>工程module下有两个资源图片文件，一个是svg，一个是png。 svg图片会在 build/generated/res/pngs 下生成多个资源，工程原有的png则不会</li>
</ul>
<h3 id="编译资源"><a href="#编译资源" class="headerlink" title="编译资源"></a>编译资源</h3><p>再来看 ResourceMerger#mergeData，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mergeData</span><span class="params">(@NonNull MergeConsumer&lt;I&gt; consumer, <span class="keyword">boolean</span> doCleanUp)</span></span>&#123;</span><br><span class="line">    consumer.start(mFactory);</span><br><span class="line">    <span class="keyword">for</span>(...) &#123;</span><br><span class="line">        ... <span class="comment">// 忽略 merge 的过程</span></span><br><span class="line">        consumer.addItem(toWrite)</span><br><span class="line">    &#125;</span><br><span class="line">    consumer.end();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后有一个consumer.end() </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">()</span> <span class="keyword">throws</span> ConsumerException </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!mCompileResourceRequests.isEmpty()) &#123;</span><br><span class="line">        mResourceCompiler.submitCompile(</span><br><span class="line">            <span class="keyword">new</span> CompileResourceRequest(</span><br><span class="line">                    fileToCompile,</span><br><span class="line">                    request.getOutputDirectory(),</span><br><span class="line">                    request.getInputDirectoryName(),</span><br><span class="line">                    request.getInputFileIsFromDependency(),</span><br><span class="line">                    pseudoLocalesEnabled,</span><br><span class="line">                    crunchPng,</span><br><span class="line">                    ImmutableMap.of(),</span><br><span class="line">                    request.getInputFile()));</span><br><span class="line">        mCompiledFileMap.put(</span><br><span class="line">            fileToCompile.getAbsolutePath(),</span><br><span class="line">            mResourceCompiler.compileOutputFor(request).getAbsolutePath());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mResourceCompiler.submitCompile 正式提交编译。<br>mResourceCompiler 的实现在子module和app有所不同，<br>在module，实例是CopyToOutputDirectoryResourceCompilationService<br>在app，实例是 WorkerExecutorResourceCompilationService</p>
<ul>
<li>子module的资源 “编译”<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> CopyToOutputDirectoryResourceCompilationService : ResourceCompilationService &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">submitCompile</span><span class="params">(request: <span class="type">CompileResourceRequest</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> <span class="keyword">out</span> = compileOutputFor(request)</span><br><span class="line">        FileUtils.mkdirs(<span class="keyword">out</span>.parentFile)</span><br><span class="line">        FileUtils.copyFile(request.inputFile, <span class="keyword">out</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">compileOutputFor</span><span class="params">(request: <span class="type">CompileResourceRequest</span>)</span></span>: File &#123;</span><br><span class="line">        <span class="keyword">val</span> parentDir = File(request.outputDirectory, request.inputDirectoryName)</span><br><span class="line">        <span class="keyword">return</span> File(parentDir, request.inputFile.name)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">close</span><span class="params">()</span></span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>在子module比较简单，就是把 request 里的 inputFile 拷贝到目标目录。<br>如果是svg生成png的case，是 build/generated/res/pngs/ 文件拷贝到 build/intermediates/package_res/<br>如果是工程中的一般资源文件，是<code>src/main/res</code> 文件拷贝到 build/intermediates/package_res/</p>
<ul>
<li>app的资源编译<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WorkerExecutorResourceCompilationService</span></span>(...) : ResourceCompilationService &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> requests: MutableList&lt;CompileResourceRequest&gt; = ArrayList()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">submitCompile</span><span class="params">(request: <span class="type">CompileResourceRequest</span>)</span></span> &#123;</span><br><span class="line">    requests.add(request)</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">close</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (...) &#123;</span><br><span class="line">      <span class="keyword">val</span> bucketRequests = requests.filterIndexed &#123; i, _ -&gt;</span><br><span class="line">        i.rem(buckets) == bucket</span><br><span class="line">      &#125;</span><br><span class="line">      workerExecutor.submit(</span><br><span class="line">        Aapt2CompileRunnable::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>,<span class="type"></span></span></span><br><span class="line">        Aapt2CompileRunnable.Params(aapt2ServiceKey, bucketRequests, errorFormatMode, <span class="literal">true</span>)</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>在close方法遍历所有request，然后在Aapt2CompileRunnable进行资源编译。 输出路径是app/build/intermediates/res/merged/debug<br>对于appt2编译，我不是很了解，这里不详细说了。</p>
<h2 id="SVG-gt-PNG-的条件"><a href="#SVG-gt-PNG-的条件" class="headerlink" title="SVG -&gt; PNG 的条件"></a>SVG -&gt; PNG 的条件</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VectorDrawableRenderer</span> <span class="keyword">implements</span> <span class="title">ResourcePreprocessor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;File&gt; <span class="title">getFilesToBeGenerated</span><span class="params">(@NonNull File inputXmlFile)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        FolderConfiguration originalConfiguration = getFolderConfiguration(inputXmlFile);</span><br><span class="line">        PreprocessingReason reason = getReasonForPreprocessing(inputXmlFile, originalConfiguration);</span><br><span class="line">        <span class="keyword">if</span> (reason == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        Collection&lt;File&gt; filesToBeGenerated = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">        DensityQualifier densityQualifier = originalConfiguration.getDensityQualifier();</span><br><span class="line">        <span class="keyword">boolean</span> validDensityQualifier = ResourceQualifier.isValid(densityQualifier);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (mMinSdk &lt; reason.getSdkThreshold() &amp;&amp; mDensities.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">for</span> (Density density : mDensities) &#123;</span><br><span class="line">               FolderConfiguration newConfiguration =</span><br><span class="line">                                FolderConfiguration.copyOf(originalConfiguration);</span><br><span class="line">               newConfiguration.setDensityQualifier(<span class="keyword">new</span> DensityQualifier(density));</span><br><span class="line">               filesToBeGenerated.add(</span><br><span class="line">                   <span class="keyword">new</span> File(</span><br><span class="line">                       getDirectory(newConfiguration),</span><br><span class="line">                       inputXmlFile.getName().replace(<span class="string">".xml"</span>, <span class="string">".png"</span>))</span><br><span class="line">               );</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> filesToBeGenerated;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码省略了诸多逻辑，我们只看关心的部分。<br>首先去获取一个reason，如果reason为空，直接返回空集合。<br>如果 mMinSdk &lt; reason.getSdkThreshold() ，项目的minSdk小于 reason的sdk阈值，则往filesToBeGenerated添加一个png路径。所以要去看如何得到reason的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> PreprocessingReason <span class="title">getReasonForPreprocessing</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull File resourceFile, @NonNull FolderConfiguration folderConfig)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 如果开启了 supportLibraryIsUsed 直接返回null。 和「背景」中说的一致</span></span><br><span class="line">    <span class="keyword">if</span> (mSupportLibraryIsUsed) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 如果 minSdk 大于 GRADIENT_SUPPORT 的版本号，也直接返回null</span></span><br><span class="line">    <span class="comment">// PreprocessingReason.GRADIENT_SUPPORT 版本号是24。 </span></span><br><span class="line">    <span class="comment">// 即到了24版本开始就没有兼容性问题了。 minSdk &gt; 24 即无需处理</span></span><br><span class="line">    <span class="keyword">if</span> (mMinSdk &gt;= PreprocessingReason.GRADIENT_SUPPORT.getSdkThreshold()) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (!isXml(resourceFile) || !isInDrawable(resourceFile)) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> (InputStream stream = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(resourceFile))) &#123;</span><br><span class="line">        XMLInputFactory factory = XMLInputFactory.newFactory();</span><br><span class="line">        XMLStreamReader xmlReader = factory.createXMLStreamReader(stream);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开始读取svg xml文件的内容，check每一个元素和属性</span></span><br><span class="line">        <span class="keyword">boolean</span> beforeFirstTag = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">while</span> (xmlReader.hasNext()) &#123;</span><br><span class="line">            <span class="keyword">int</span> event = xmlReader.next();</span><br><span class="line">            <span class="keyword">if</span> (event == XMLStreamReader.START_ELEMENT) &#123;</span><br><span class="line">                <span class="keyword">if</span> (beforeFirstTag) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!TAG_VECTOR.equals(xmlReader.getLocalName())) &#123;</span><br><span class="line">                        <span class="comment">// 如果不是 vector 直接不用check了</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    beforeFirstTag = <span class="keyword">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (TAG_GRADIENT.equals(xmlReader.getLocalName())) &#123;</span><br><span class="line">                        <span class="comment">// 找到 gradient 这个元素，返回一个reason</span></span><br><span class="line">                        <span class="comment">// GRADIENT_SUPPORT 的版本阈值是24</span></span><br><span class="line">                        <span class="keyword">return</span> PreprocessingReason.GRADIENT_SUPPORT;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">int</span> n = xmlReader.getAttributeCount();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">                        <span class="comment">// 找到 fillType 这个属性，返回一个reason 。 </span></span><br><span class="line">                        <span class="comment">// FILLTYPE_SUPPORT 的版本阈值是 24</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="string">"fillType"</span>.equals(xmlReader.getAttributeLocalName(i))</span><br><span class="line">                                &amp;&amp; NS_RESOURCES.equals(xmlReader.getAttributeNamespace(i))) &#123;</span><br><span class="line">                            <span class="keyword">return</span> PreprocessingReason.FILLTYPE_SUPPORT;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!beforeFirstTag &amp;&amp; mMinSdk &lt; PreprocessingReason.VECTOR_SUPPORT.getSdkThreshold()) &#123;</span><br><span class="line">            <span class="comment">// 判断是minSdk否是压根就不支持 vector ，返回一个reason</span></span><br><span class="line">            <span class="comment">// VECTOR_SUPPORT 的版本阈值是 21</span></span><br><span class="line">            <span class="keyword">return</span> PreprocessingReason.VECTOR_SUPPORT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (XMLStreamException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(</span><br><span class="line">                <span class="string">"Failed to parse resource file "</span> + resourceFile.getAbsolutePath(), e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很明显，AGP 只会判断svg文件里的 gradient 和 fillType 这两个东西。<br>gradient是颜色渐变<br>fillType 专业性太强，搜了一圈看不懂，不知道是做什么的。。。<br>他们的版本号阈值都是24，svg文件中出现这两个东西，并且 minSdk &lt; 24 时就会触发 svg-&gt;png 的生成</p>
<h2 id="如何处理"><a href="#如何处理" class="headerlink" title="如何处理"></a>如何处理</h2><p>在我们的项目里，svg自动生成png的case太多了，大概接近300个资源图片。 需要去治理一波。<br>生成的png直接导致我们使用svg去减小包体积的初衷失去意义。<br>但是不能一个一个改，太费事。</p>
<p>有一个开源的 McImage 插件，作用是把项目中的所有资源转换成webp，我们可以模仿它</p>
<p>AGP提供了 variant.getAllRawAndroidResources().files 这个api，在app下使用，可以获取到所有的resource目录。 打印所有的目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 子module的 build/intermediates/packaged_res 目录</span><br><span class="line">/Users/xx/PluginX/module_1/build/intermediates/packaged_res/debug</span><br><span class="line">// 依赖库的res目录</span><br><span class="line">/Users/xx/.gradle/caches/transforms-2/files-2.1/414fc23eb49f389f342a6e17218892be/appcompat-1.2.0/res</span><br><span class="line">/Users/xx/.gradle/caches/transforms-2/files-2.1/72202874f0ee490d85b35e8bc8155d2b/constraintlayout-1.1.3/res</span><br><span class="line">/Users/xx/.gradle/caches/transforms-2/files-2.1/52e4a4d01e3d8c6a6c3d516d66f6acc9/recyclerview-1.0.0/res</span><br><span class="line">/Users/xx/.gradle/caches/transforms-2/files-2.1/83248d60fee84d269b4d5ae691d6e421/jetified-appcompat-resources-1.2.0/res</span><br><span class="line">/Users/xx/.gradle/caches/transforms-2/files-2.1/5fddbd55bd0ad4a84e0959052d0c417d/coordinatorlayout-1.0.0/res</span><br><span class="line">/Users/xx/.gradle/caches/transforms-2/files-2.1/05736e5c1eb0ab8976aa5868fca67ffe/core-1.3.1/res</span><br></pre></td></tr></table></figure></p>
<p>结合上面 MergeResources 的分析。<br>子module会在 packageDebugResources 任务，把module所有资源汇总拷贝到 build/intermediates/packaged_res/<br>在app也能拿到所有子module汇总拷贝之后的这个目录。<br>可以在app的 mergeDebugResources 任务之前，插入一个我们自己的任务。<br>作用是收集 getAllRawAndroidResources().files 目录里的所有资源文件，查找删除同名的多余资源图片，如果存在xml后缀的svg资源和多个同名的png资源，只保留 xxhdpi 目录下的png图片资源。<br>实践来看，可行，没有报错，打出来的apk文件安装使用也都正常。 </p>
<p>TODO：是否可以在 mergeDebugResources 之后进行 hook ？</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考:"></a>参考:</h2><p><a href="http://www.youkmi.cn/2020/01/01/android-zhong-gradle-yuan-li-yi-ji-ji-zhi-shen-ru-fen-xi/" target="_blank" rel="noopener">Android中Gradle原理以及机制深入分析</a><br><a href="https://juejin.cn/post/7060337237761720334" target="_blank" rel="noopener">gradle编译打包过程分析之ProcessAndroidResources</a><br><a href="https://smallsoho.com/android/2017/04/07/McImage%E6%8F%92%E4%BB%B6%E8%A7%A3%E6%9E%90/" target="_blank" rel="noopener">McImage插件解析（旧版本）</a></p>

    </div>

    
    
    

      <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/2022/08/27/Base/网络相关知识点/" rel="next" title="网络相关知识点">
                  <i class="fa fa-chevron-left"></i> 网络相关知识点
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/2022/09/12/Java/线程池/" rel="prev" title="线程池">
                  线程池 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#背景："><span class="nav-text">背景：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MergeResources"><span class="nav-text">MergeResources</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#关键1-ResourcePreprocessor"><span class="nav-text">关键1 ResourcePreprocessor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关键2-ResourceSet-loadFromFiles"><span class="nav-text">关键2 ResourceSet#loadFromFiles</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关键3-merger-mergeData"><span class="nav-text">关键3 merger#mergeData</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编译资源"><span class="nav-text">编译资源</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SVG-gt-PNG-的条件"><span class="nav-text">SVG -&gt; PNG 的条件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何处理"><span class="nav-text">如何处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-text">参考:</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="BrightStone"
    src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">BrightStone</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">73</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">BrightStone</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://mist.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.5.0
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
<script src="/js/utils.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>













  

  

</body>
</html>
